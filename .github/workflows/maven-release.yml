name: Maven Release (via GitHub Release)

on:
  release:
    types: [published]  # Triggers when a GitHub Release is published

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write       # Push tags / commits
      packages: write       # Publish packages if using GitHub Packages

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Required for Maven release tag handling
          ref: main        # Checkout main branch instead of detached HEAD
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          server-id: github               # Must match <id> in distributionManagement
          settings-path: ${{ github.workspace }}  # Location for settings.xml

      - name: Create Maven settings.xml
        run: |
          cat > ${{ github.workspace }}/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 
                    http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Configure Git identity
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      # Derive version from GitHub release tag (e.g. v1.2.3 → 1.2.3)
      - name: Determine version info
        id: vars
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Checkout release tag
        run: |
          git checkout ${{ github.event.release.tag_name }}

      - name: Set version in POM
        run: |
          mvn versions:set -DnewVersion=${{ steps.vars.outputs.version }} -DgenerateBackupPoms=false

      - name: Build and deploy
        run: |
          mvn -B clean deploy -s ${{ github.workspace }}/settings.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # After successful release, bump version to next SNAPSHOT
      - name: Checkout main branch
        run: |
          git checkout main
          git pull origin main

      - name: Bump to next SNAPSHOT version
        id: next_version
        run: |
          CURRENT_VERSION="${{ steps.vars.outputs.version }}"
          
          # Parse version components (e.g., 0.8.3 → 0.8.4-SNAPSHOT)
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH="${VERSION_PARTS[2]}"
          
          # Increment patch version
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-SNAPSHOT"
          
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          
          # Update POM with next SNAPSHOT version
          mvn versions:set -DnewVersion=$NEXT_VERSION -DgenerateBackupPoms=false

      - name: Commit and push SNAPSHOT version
        run: |
          git add pom.xml
          git commit -m "[maven-release-plugin] prepare for next development iteration"
          git push origin main

      - name: Completion
        run: echo "✅ Maven release completed and version bumped to ${{ steps.next_version.outputs.next_version }}"
